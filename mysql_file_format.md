MySQL 5.6

## 最简单的数据库实现 



## 自己设计简单的表记录文件

从 DDL 开始说起：
- 字段是可以变长的（变长类型的编码集）
- 字段可以为 null
- 字段过长时的分散存储
- 数据内容
- 数据记录的删除
- 数据页中的记录检索，跳表二分查找
- 数据页之间的串联

## InnoDB  compact 行记录结构

创建一个演示用表 `record_format_demo` :
``` sql
CREATE TABLE record_format_demo ( 
	c1 VARCHAR(10),
	c2 VARCHAR(10) NOT NULL,
	c3 CHAR(10), 
	c4 VARCHAR(10)
) CHARSET=ascii ROW_FORMAT=COMPACT;
```

写入两条数据：
``` sql
INSERT INTO record_format_demo(c1, c2, c3, c4) VALUES
('aaaa', 'bbb', 'cc', 'd'), 
('eeee', 'fff', NULL, NULL);
```

## 行记录结构

InnoDB 引擎中有 `Compact`、`Redundant`、`Dynamic`、`Compressing` 四种行格式。其中 `Redunant` 行格式是 `MySQL5.0` 之前用的一种行格式，`Dynamic` 、`Compressing` 是 `Compact` 格式基础上进行一些改进的格式。故本章主要以 `Compact` 行格式进行讲解。

### Compact 行格式

![](./assets/compact_row_format.png)

#### 变长字段长度列表

**什么字段会被存储字段内容长度？**

通过 `varchar(M)`、`varbinary(M)`、`Text`、`Blob` 格式定义的字段。或者使用变长字符集（如 `UTF8`）的 `char(M)`字段。

**使用多少个字节用来存储字段内容长度？**

字段能存储的最大长度（M * N） =  字段定义长度 M（`varchar(M)`）* 字符集最大字节数 N（比如 UTF8 为 1~3 字节长度，最大字节数为 3）
字段实际存储的长度  = L

- 当 M * N <= 255，使用 1 个字节存储字段内容占用的字符数
- 当 M * N > 255，且 L <= 127 时，使用 1 字节表示字段内容占用的字符数
- 当 M * N > 255，却 L > 127 时，使用 2 字节表示字段内容占用的字符数

注意：
1. 当 M * N > 255 时，该字段长度长度的字节中第一个为 0 时，代表该字节为单独字段内容长度，为 1 时，代表该字节与前一个字节共同表示字段内容长度
2. 因为字符字段最大长度为 65535（2 ^ 16）字节，但是一般数据页长度为 16KB （2 ^ 12），所以当字段长度大于一定字节数时，会将部分数据存储在另一个数据页中，此时保留在当前页上的数据内容长度使用 2 个字节足够记录

#TODO 增加实际记录的二进制数据截图
#TODO 变长字符集的存储形式
#### NULL 值列表

只有可以存储 NULL 值的列才会被统计到 NULL 值列表中。每个允许存储 NULL 值的列对应一个二进制位：
- 二进制位的值为 1 时，代表该列的值为 NULL
- 二进制位的值为 0 时，代表该列的值不为 NULL

NULL 值列表必须用整数个字节位表示，如果二进制位个数不为整个字节，则在高位补 0。

上述示例行记录的 NULL 值列表效果图如下：
![](row1_null_value_list.png)
`c1`、`c3`、`c4`这3个列的值都不为`NULL`

![](row2_null_value_list.png)
`c1`、`c3`、`c4`这3个列中`c3`和`c4`的值都为`NULL`

#TODO 增加实际记录的二进制数据截图

#### 记录头信息

另一个描述记录的记录头信息由固定的 5 个字节组成，不同的二进制位表示不同的意思，具体如下：

|名称|大小（单位：bit）|描述|
|:-:|:-:|:-:|
|`预留位1`|`1`|没有使用|
|`预留位2`|`1`|没有使用|
|`delete_mask`|`1`|标记该记录是否被删除|
|`min_rec_mask`|`1`|B+树的每层非叶子节点中的最小记录都会添加该标记|
|`n_owned`|`4`|表示当前记录拥有的记录数|
|`heap_no`|`13`|表示当前记录在记录堆的位置信息|
|`record_type`|`3`|表示当前记录的类型，`0`表示普通记录，`1`表示B+树非叶子节点记录，`2`表示最小记录，`3`表示最大记录|
|`next_record`|`16`|表示下一条记录的相对位置|

![](compact_row_format_header.png)
#### 真实数据

在一般表记录中，除了真实数据之外，MySQL 会为每个记录默认的添加一些列，具体如下：

|列名|是否必须|占用空间|描述|
|:-:|:-:|:-:|:-:|
|`DB_ROW_ID`|否|`6`字节|行ID，唯一标识一条记录|
|`DB_TRX_ID`|是|`6`字节|事务ID|
|`DB_ROLL_PTR`|是|`7`字节|回滚指针|

当表中有用户自定义的主键或者建立 `Unique` 索引的键，则 InnoDB 将以此为主键。如果没有，则添加一个 `DB_ROW_ID` 隐藏列作为主键。

上述的示例行数据结构图如下：
![](compact_row_data.png)

- 第一条记录的 `c3` 字段虽然内容仅占 2 个字节（'cc'），但因为其实固定长度，所以使用空白符（0x20）将剩余的 8 个字节进行填充
- 第二条记录的 `c3`、`c4` 列值为 NULL，其被存储于前边的 NULL 值列表处，故在真实数据处不再冗余存储

## 数据页结构

页是`InnoDB`管理存储空间的基本单位，一个页的大小一般是`16KB`。`InnoDB`为了不同的目的而设计了许多种不同类型的`页`，比如存放表空间头部信息的页，存放`Insert Buffer`信息的页，存放`INODE`信息的页，存放`undo`日志信息的页等。本章我们主要讲述数据页。页的基本结构如下：

![](page_format.png)

|   |   |   |   |
|:-:|:-:|:-:|:-:|
|`File Header`|文件头部|`38`字节|页的一些通用信息|
|`Page Header`|页面头部|`56`字节|数据页专有的一些信息|
|`Infimum + Supremum`|最小记录和最大记录|`26`字节|两个虚拟的行记录|
|`User Records`|用户记录|不确定|实际存储的行记录内容|
|`Free Space`|空闲空间|不确定|页中尚未使用的空间|
|`Page Directory`|页面目录|不确定|页中的某些记录的相对位置|
|`File Trailer`|文件尾部|`8`字节|校验页是否完整|

### 记录在页中的存储

#### 记录的删除

#### 记录的串联

### Page Directory

#### 记录的二分查找

### Page Header

### File Header

### File Tailer


